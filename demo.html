<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proppanda â€” Property Assistant</title>
  <style>
    /* â”€â”€ Reset & Base â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #eef2f7;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 20px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,.06);
      z-index: 10;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .agent-avatar {
      width: 38px; height: 38px; border-radius: 50%;
      background: linear-gradient(135deg, #1a56db, #3b82f6);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 700; font-size: 14px; flex-shrink: 0;
    }
    .agent-info .agent-name { font-weight: 600; font-size: 15px; color: #1e293b; }
    .agent-info .agent-sub  { font-size: 12px; color: #64748b; }
    .online-dot {
      display: inline-block; width: 7px; height: 7px; border-radius: 50%;
      background: #22c55e; margin-right: 4px;
    }
    .header-actions { display: flex; gap: 8px; }
    .btn-icon {
      border: none; background: #f1f5f9; border-radius: 8px;
      width: 36px; height: 36px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #64748b; transition: background .15s;
    }
    .btn-icon:hover { background: #e2e8f0; color: #1e293b; }

    /* â”€â”€ Settings Overlay â”€â”€ */
    .settings-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.35); z-index: 100;
      align-items: center; justify-content: center;
    }
    .settings-overlay.open { display: flex; }
    .settings-card {
      background: #fff; border-radius: 16px; padding: 28px;
      width: min(440px, 92vw); box-shadow: 0 20px 60px rgba(0,0,0,.18);
    }
    .settings-card h2 { font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 18px; }
    .settings-card label { font-size: 13px; font-weight: 600; color: #475569; display: block; margin-bottom: 5px; }
    .settings-card input {
      width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 9px;
      font-size: 14px; color: #1e293b; margin-bottom: 14px; outline: none;
      transition: border-color .15s;
    }
    .settings-card input:focus { border-color: #1a56db; }
    .settings-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 4px; }
    .btn-save {
      padding: 9px 20px; background: #1a56db; color: #fff; border: none;
      border-radius: 9px; font-size: 14px; font-weight: 600; cursor: pointer;
      transition: background .15s;
    }
    .btn-save:hover { background: #1d4ed8; }
    .btn-cancel {
      padding: 9px 20px; background: #f1f5f9; color: #475569; border: none;
      border-radius: 9px; font-size: 14px; font-weight: 600; cursor: pointer;
    }
    .btn-cancel:hover { background: #e2e8f0; }

    /* â”€â”€ Chat Area â”€â”€ */
    .chat-area {
      flex: 1; overflow-y: auto; padding: 20px 16px;
      display: flex; flex-direction: column; gap: 16px;
      scroll-behavior: smooth;
    }
    .chat-area::-webkit-scrollbar { width: 5px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* â”€â”€ Messages â”€â”€ */
    .msg-row { display: flex; gap: 10px; max-width: 820px; width: 100%; }
    .msg-row.user   { flex-direction: row-reverse; margin-left: auto; }
    .msg-row.bot    { margin-right: auto; }

    .msg-avatar {
      width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700; margin-top: 2px;
    }
    .msg-avatar.bot-av {
      background: linear-gradient(135deg, #1a56db, #3b82f6); color: #fff;
    }
    .msg-avatar.user-av {
      background: #e2e8f0; color: #64748b;
    }

    .msg-body { display: flex; flex-direction: column; gap: 4px; max-width: calc(100% - 44px); }
    .msg-row.user .msg-body { align-items: flex-end; }

    .bubble {
      padding: 11px 15px; border-radius: 16px; font-size: 14.5px;
      line-height: 1.6; color: #1e293b; word-break: break-word;
    }
    .bubble.user-bubble {
      background: #1a56db; color: #fff;
      border-bottom-right-radius: 4px;
    }
    .bubble.bot-bubble {
      background: #fff; border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
    }
    .bubble p { margin-bottom: 6px; }
    .bubble p:last-child { margin-bottom: 0; }

    /* â”€â”€ Property Cards â”€â”€ */
    .properties-grid {
      display: grid; gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      max-width: 100%;
    }
    .prop-card {
      background: #fff; border-radius: 14px; overflow: hidden;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0,0,0,.07);
      transition: transform .18s, box-shadow .18s;
    }
    .prop-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,.11); }
    .prop-img-wrap {
      width: 100%; height: 160px; overflow: hidden; background: #f1f5f9;
      position: relative;
    }
    .prop-img-wrap img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform .3s;
    }
    .prop-card:hover .prop-img-wrap img { transform: scale(1.04); }
    .prop-img-placeholder {
      width: 100%; height: 100%; display: flex; align-items: center;
      justify-content: center; font-size: 36px; color: #cbd5e1;
    }
    .prop-body { padding: 13px 14px 14px; }
    .prop-name {
      font-weight: 700; font-size: 15px; color: #1e293b;
      margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .prop-room-no { font-size: 12px; color: #94a3b8; margin-bottom: 8px; }
    .prop-price {
      font-size: 17px; font-weight: 800; color: #1a56db; margin-bottom: 7px;
    }
    .prop-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
    .badge {
      font-size: 11.5px; font-weight: 500; padding: 3px 9px; border-radius: 20px;
      border: 1px solid #e2e8f0; color: #475569; background: #f8fafc;
    }
    .prop-addr { font-size: 12.5px; color: #64748b; display: flex; align-items: center; gap: 4px; }

    /* â”€â”€ Suggestions â”€â”€ */
    .suggestions { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 4px; }
    .suggestion-chip {
      border: 1.5px solid #1a56db; color: #1a56db; background: #eff6ff;
      border-radius: 20px; padding: 5px 14px; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: background .15s, color .15s;
    }
    .suggestion-chip:hover { background: #1a56db; color: #fff; }

    /* â”€â”€ Typing indicator â”€â”€ */
    .typing-row { display: flex; gap: 10px; max-width: 820px; }
    .typing-bubble {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 16px;
      border-bottom-left-radius: 4px; padding: 13px 16px;
      display: flex; gap: 5px; align-items: center;
    }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: #94a3b8; animation: bounce 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    /* â”€â”€ Input Area â”€â”€ */
    .input-area {
      background: #fff; border-top: 1px solid #e2e8f0;
      padding: 12px 16px; flex-shrink: 0;
      box-shadow: 0 -1px 4px rgba(0,0,0,.04);
    }
    .input-row { display: flex; gap: 10px; align-items: flex-end; max-width: 820px; margin: 0 auto; }
    textarea {
      flex: 1; resize: none; border: 1.5px solid #e2e8f0; border-radius: 12px;
      padding: 11px 14px; font-size: 14.5px; font-family: inherit; color: #1e293b;
      outline: none; transition: border-color .15s; max-height: 120px; min-height: 44px;
      line-height: 1.5;
    }
    textarea:focus { border-color: #1a56db; }
    textarea::placeholder { color: #94a3b8; }
    .btn-send {
      width: 44px; height: 44px; border-radius: 12px;
      background: #1a56db; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #fff; flex-shrink: 0; transition: background .15s, transform .1s;
    }
    .btn-send:hover  { background: #1d4ed8; }
    .btn-send:active { transform: scale(.93); }
    .btn-send:disabled { background: #94a3b8; cursor: not-allowed; }
    .hint { font-size: 12px; color: #94a3b8; text-align: center; margin-top: 6px; }

    /* â”€â”€ Welcome Message â”€â”€ */
    .welcome {
      text-align: center; padding: 32px 20px;
      color: #64748b; font-size: 14px;
    }
    .welcome-icon { font-size: 48px; margin-bottom: 12px; }
    .welcome h2 { font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 6px; }
    .welcome p  { max-width: 360px; margin: 0 auto; }

    /* â”€â”€ Timestamp â”€â”€ */
    .ts { font-size: 11px; color: #94a3b8; padding: 0 2px; }

    /* â”€â”€ Bold in bubble â”€â”€ */
    .bubble strong { font-weight: 700; }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <div class="agent-avatar" id="agentAvatarInitial">P</div>
    <div class="agent-info">
      <div class="agent-name" id="agentNameDisplay">Proppanda Assistant</div>
      <div class="agent-sub"><span class="online-dot"></span>Online Â· Real Estate Bot</div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn-icon" title="New Chat" onclick="newChat()">
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
    </button>
    <button class="btn-icon" title="Settings" onclick="openSettings()">
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </button>
  </div>
</header>

<!-- SETTINGS OVERLAY -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-card">
    <h2>âš™ï¸ Chat Settings</h2>
    <label>API Base URL</label>
    <input type="text" id="cfgApiBase" placeholder="http://localhost:8000/api/v1" />
    <label>API Key (X-API-KEY)</label>
    <input type="password" id="cfgApiKey" placeholder="Enter your API key" />
    <label>Agent ID</label>
    <input type="text" id="cfgAgentId" placeholder="agent_123" />
    <label>Your Display Name</label>
    <input type="text" id="cfgUserName" placeholder="User" />
    <div class="settings-footer">
      <button class="btn-cancel" onclick="closeSettings()">Cancel</button>
      <button class="btn-save" onclick="saveSettings()">Save & Close</button>
    </div>
  </div>
</div>

<!-- CHAT AREA -->
<div class="chat-area" id="chatArea">
  <div class="welcome" id="welcomeMsg">
    <div class="welcome-icon">ğŸ </div>
    <h2>Welcome to Proppanda</h2>
    <p>Your AI property assistant. Ask me about co-living, rooms for rent, or residential units in Singapore.</p>
  </div>
</div>

<!-- INPUT AREA -->
<div class="input-area">
  <div class="input-row">
    <textarea id="msgInput" placeholder="Ask about properties, budget, locationâ€¦" rows="1"
      onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="btn-send" id="sendBtn" onclick="sendMessage()">
      <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.2">
        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
      </svg>
    </button>
  </div>
  <div class="hint">Press Enter to send Â· Shift+Enter for new line</div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG  (stored in localStorage)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_CONFIG = {
  apiBase:  'http://localhost:8000/api/v1',
  apiKey:   '',
  agentId:  'agent_123',
  userName: 'User'
};

let cfg = { ...DEFAULT_CONFIG, ...JSON.parse(localStorage.getItem('ppConfig') || '{}') };
let sessionId = null;

function openSettings() {
  document.getElementById('cfgApiBase').value  = cfg.apiBase;
  document.getElementById('cfgApiKey').value   = cfg.apiKey;
  document.getElementById('cfgAgentId').value  = cfg.agentId;
  document.getElementById('cfgUserName').value = cfg.userName;
  document.getElementById('settingsOverlay').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open');
}
function saveSettings() {
  cfg.apiBase  = document.getElementById('cfgApiBase').value.trim()  || DEFAULT_CONFIG.apiBase;
  cfg.apiKey   = document.getElementById('cfgApiKey').value.trim();
  cfg.agentId  = document.getElementById('cfgAgentId').value.trim()  || DEFAULT_CONFIG.agentId;
  cfg.userName = document.getElementById('cfgUserName').value.trim() || DEFAULT_CONFIG.userName;
  localStorage.setItem('ppConfig', JSON.stringify(cfg));
  closeSettings();
}
function newChat() {
  sessionId = null;
  document.getElementById('chatArea').innerHTML =
    `<div class="welcome" id="welcomeMsg">
      <div class="welcome-icon">ğŸ </div>
      <h2>Welcome to Proppanda</h2>
      <p>Your AI property assistant. Ask me about co-living, rooms for rent, or residential units in Singapore.</p>
     </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INPUT HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SEND MESSAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage(text) {
  const input = document.getElementById('msgInput');
  const msg   = (text ?? input.value).trim();
  if (!msg) return;
  if (!text) { input.value = ''; autoResize(input); }

  removeWelcome();
  appendUserBubble(msg);
  scrollBottom();
  setBusy(true);
  const typingId = showTyping();

  try {
    const res = await fetch(`${cfg.apiBase}/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-KEY': cfg.apiKey
      },
      body: JSON.stringify({
        message:    msg,
        agent_id:   cfg.agentId,
        session_id: sessionId,
        user_name:  cfg.userName
      })
    });

    removeTyping(typingId);
    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      appendBotBubble(`âš ï¸ Error ${res.status}: ${err.detail || 'Something went wrong.'}`, [], []);
    } else {
      const data = await res.json();
      sessionId = data.session_id;
      appendBotMessage(data);
    }
  } catch (e) {
    removeTyping(typingId);
    appendBotBubble(`âš ï¸ Could not reach the server. Make sure the API is running at <strong>${cfg.apiBase}</strong>`, [], []);
  } finally {
    setBusy(false);
    scrollBottom();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER MESSAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendBotMessage(data) {
  const { response, properties = [], contextual_suggestions = [] } = data;
  const { textSections, propCards } = parseResponse(response, properties);

  const chatArea = document.getElementById('chatArea');
  const row = document.createElement('div');
  row.className = 'msg-row bot';

  const avatarHtml = `<div class="msg-avatar bot-av">P</div>`;
  const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  let bodyHTML = '';

  // Render text sections and property cards in order
  for (const section of textSections) {
    if (section.type === 'text' && section.content.trim()) {
      bodyHTML += `<div class="bubble bot-bubble">${renderMarkdown(section.content)}</div>`;
    } else if (section.type === 'props') {
      bodyHTML += renderPropertyGrid(section.cards);
    }
  }

  // Suggestions
  if (contextual_suggestions && contextual_suggestions.length) {
    const chips = contextual_suggestions
      .map(s => `<button class="suggestion-chip" onclick="sendMessage('${escHtml(s)}')">${escHtml(s)}</button>`)
      .join('');
    bodyHTML += `<div class="suggestions">${chips}</div>`;
  }

  bodyHTML += `<span class="ts">${ts}</span>`;

  row.innerHTML = `${avatarHtml}<div class="msg-body">${bodyHTML}</div>`;
  chatArea.appendChild(row);
}

function appendBotBubble(html, props, suggestions) {
  appendBotMessage({ response: html, properties: props || [], contextual_suggestions: suggestions || [] });
}

function appendUserBubble(text) {
  const chatArea = document.getElementById('chatArea');
  const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const row = document.createElement('div');
  row.className = 'msg-row user';
  row.innerHTML = `
    <div class="msg-avatar user-av">U</div>
    <div class="msg-body">
      <div class="bubble user-bubble">${escHtml(text)}</div>
      <span class="ts">${ts}</span>
    </div>`;
  chatArea.appendChild(row);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PARSE RESPONSE â€” split text / property cards
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIVIDER = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';

function parseResponse(response, apiProperties) {
  // If we have a rich properties array from API with media, use those for card rendering
  const apiPropMap = {};
  for (const p of (apiProperties || [])) {
    const key = (p.property_name || p.condo_name || '').toLowerCase();
    if (key) apiPropMap[key] = p;
  }

  const parts = response.split(DIVIDER);
  const textSections = [];
  let propBuffer = [];
  let leadText = '';

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i].trim();
    if (!part) continue;

    const isPropertyBlock = /^ğŸ /.test(part);

    if (isPropertyBlock) {
      // Flush any accumulated lead text
      if (leadText.trim()) {
        textSections.push({ type: 'text', content: leadText.trim() });
        leadText = '';
      }
      const card = parsePropertyBlock(part, apiPropMap);
      propBuffer.push(card);
    } else {
      // Not a property block â€” flush accumulated property cards first
      if (propBuffer.length) {
        textSections.push({ type: 'props', cards: [...propBuffer] });
        propBuffer = [];
      }
      // Accumulate as text
      if (leadText) leadText += '\n\n' + part;
      else leadText = part;
    }
  }

  // Flush remainders
  if (propBuffer.length) {
    textSections.push({ type: 'props', cards: [...propBuffer] });
  }
  if (leadText.trim()) {
    textSections.push({ type: 'text', content: leadText.trim() });
  }

  return { textSections, propCards: [] };
}

function parsePropertyBlock(block, apiPropMap) {
  const lines = block.split('\n').map(l => l.trim()).filter(Boolean);

  // Name line: ğŸ  **Name** (Room X) OR ğŸ  **Name**
  const nameLine   = lines[0] || '';
  const nameMatch  = nameLine.match(/\*\*(.+?)\*\*/);
  const name       = nameMatch ? nameMatch[1] : nameLine.replace('ğŸ ', '').trim();
  const roomMatch  = nameLine.match(/\(Room\s+(.+?)\)/i) || nameLine.match(/\(Unit\s+(.+?)\)/i);
  const roomNo     = roomMatch ? roomMatch[1] : null;

  // Price line: ğŸ’° $X/mo | ğŸ¢ Type | N BR
  const priceLine  = lines.find(l => l.startsWith('ğŸ’°')) || '';
  const priceMatch = priceLine.match(/\$([0-9,]+)/);
  const price      = priceMatch ? `$${priceMatch[1]}` : null;
  const typeMatch  = priceLine.match(/ğŸ¢\s+(.+?)(?:\s*\||\s*$)/);
  const propType   = typeMatch ? typeMatch[1].trim() : null;
  const brMatch    = priceLine.match(/(\d+)\s*BR/i);
  const bedrooms   = brMatch ? parseInt(brMatch[1]) : null;

  // Address line: ğŸ“ ...
  const addrLine   = lines.find(l => l.startsWith('ğŸ“')) || '';
  const address    = addrLine.replace('ğŸ“', '').trim();

  // Image URL: ğŸ–¼ ...
  const imgLine    = lines.find(l => l.startsWith('ğŸ–¼')) || '';
  let imageUrl     = imgLine.replace('ğŸ–¼', '').trim();

  // Enrich from API properties if image not found in text
  if (!imageUrl) {
    const key = name.toLowerCase();
    const apiP = apiPropMap[key];
    if (apiP) {
      imageUrl = extractFirstMedia(apiP.media);
    }
  }

  return { name, roomNo, price, propType, bedrooms, address, imageUrl };
}

function extractFirstMedia(media) {
  if (!media) return '';
  try {
    if (typeof media === 'string' && media.startsWith('[')) {
      const arr = JSON.parse(media);
      return (arr && arr[0]) || '';
    }
    if (typeof media === 'string') return media;
    if (Array.isArray(media)) return media[0] || '';
  } catch {}
  return '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPropertyGrid(cards) {
  const items = cards.map(c => renderPropertyCard(c)).join('');
  return `<div class="properties-grid">${items}</div>`;
}

function renderPropertyCard(c) {
  const imgHtml = c.imageUrl
    ? `<img src="${escHtml(c.imageUrl)}" alt="${escHtml(c.name)}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\'prop-img-placeholder\'>ğŸ </div>'" />`
    : `<div class="prop-img-placeholder">ğŸ </div>`;

  const badges = [];
  if (c.propType) badges.push(`<span class="badge">${escHtml(c.propType)}</span>`);
  if (c.bedrooms) badges.push(`<span class="badge">ğŸ› ${c.bedrooms} BR</span>`);
  const badgesHtml = badges.length ? `<div class="prop-badges">${badges.join('')}</div>` : '';

  const roomNoHtml = c.roomNo ? `<div class="prop-room-no">Unit ${escHtml(c.roomNo)}</div>` : '';
  const priceHtml  = c.price  ? `<div class="prop-price">${escHtml(c.price)}<span style="font-size:13px;font-weight:500;color:#64748b">/mo</span></div>` : '';
  const addrHtml   = c.address ? `<div class="prop-addr"><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg>${escHtml(c.address)}</div>` : '';

  return `
    <div class="prop-card">
      <div class="prop-img-wrap">${imgHtml}</div>
      <div class="prop-body">
        <div class="prop-name">${escHtml(c.name)}</div>
        ${roomNoHtml}
        ${priceHtml}
        ${badgesHtml}
        ${addrHtml}
      </div>
    </div>`;
}

function renderMarkdown(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n\n+/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^(.+)$/, '<p>$1</p>');
}

function escHtml(s) {
  return String(s)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TYPING INDICATOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let typingCounter = 0;
function showTyping() {
  const id = 'typing_' + (++typingCounter);
  const chatArea = document.getElementById('chatArea');
  const row = document.createElement('div');
  row.className = 'typing-row'; row.id = id;
  row.innerHTML = `
    <div class="msg-avatar bot-av">P</div>
    <div class="typing-bubble">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>`;
  chatArea.appendChild(row);
  scrollBottom();
  return id;
}
function removeTyping(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setBusy(busy) {
  const btn   = document.getElementById('sendBtn');
  const input = document.getElementById('msgInput');
  btn.disabled   = busy;
  input.disabled = busy;
}
function scrollBottom() {
  const ca = document.getElementById('chatArea');
  setTimeout(() => ca.scrollTo({ top: ca.scrollHeight, behavior: 'smooth' }), 50);
}
function removeWelcome() {
  const w = document.getElementById('welcomeMsg');
  if (w) w.remove();
}

// Close settings when clicking outside the card
document.getElementById('settingsOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeSettings();
});

// Auto-open settings if no API key set
window.addEventListener('load', () => {
  if (!cfg.apiKey) openSettings();
});
</script>
</body>
</html>
